#!/usr/bin/env -S bash -e
#
# mpv
# https://github.com/mpv-player/mpv.git
#
cd "$(dirname "$0")"
set -a; . .env; set +a

# Version management
BACKUP_FILE="src/mpv/MPV_VERSION.bak"

# Update version with git hash before build
GIT_HASH=$(git rev-parse --short HEAD)
if [ ! -f "$BACKUP_FILE" ]; then
    cp src/mpv/MPV_VERSION "$BACKUP_FILE"
fi
sed -i '' "s/UNKNOWN/$GIT_HASH/" src/mpv/MPV_VERSION
echo "Updated version with git hash: $GIT_HASH"

pkgname="mpv"
pkgdir="${STOWDIR}/${pkgname}"
srcdir="src/mpv"
builddir="${TMPDIR:-/tmp}/build.${pkgname}"

if [ "$1" == "--bundle" ]; then
  bundle=1
  shift
fi

echo
echo "*** $0: started"

rm -rf "${builddir}"

meson setup "${builddir}" "${srcdir}" \
  --prefix="${pkgdir}" \
  -Dwrap_mode=nodownload \
  -Dbuildtype=release \
  -Dlibmpv=true \
  -Djavascript=enabled \
  -Db_lto=true \
  -Db_lto_mode=thin \
  -Dlua=luajit \
  -Dgl=disabled \
  -Dmacos-touchbar=disabled \
  "$@"
  # -Duchardet=enabled \
meson compile -C "${builddir}"

if [ -n "${bundle}" ]; then
  mkdir -p ~/.config/vulkan
  ln -sfn "${PREFIX}"/etc/vulkan/icd.d ~/.config/vulkan/icd.d

  # Remove existing bundle if it exists
  rm -f mpv.tar.gz

  meson compile -C "${builddir}" macos-bundle
  rm -f mpv.tar.gz
  tar -czvf mpv.tar.gz -C "${builddir}" mpv.app
fi

rm -rf "${pkgdir}"

meson install -C "${builddir}" --tags runtime,devel
stow -Rd "${STOWDIR}" "${pkgname}"

rm -rf "${builddir}"

# Revert version changes after build
if [ -f "$BACKUP_FILE" ]; then
    cp "$BACKUP_FILE" src/mpv/MPV_VERSION
    rm "$BACKUP_FILE"
    echo "Reverted version to original state"
fi
echo "*** $0: finished"
